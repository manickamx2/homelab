- name: Verify kubeconfig exists
  stat:
    path: "{{ kubeconfig_path }}"
  register: kubeconfig_stat

- name: Fail if kubeconfig is missing
  fail:
    msg: "kubeconfig.yaml not found at {{ kubeconfig_path }}"
  when: not kubeconfig_stat.stat.exists

- name: Install Gateway API CRDs
  shell: |
    kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/{{ gateway_api_version }}/standard-install.yaml
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Add Cilium Helm repo
  kubernetes.core.helm_repository:
    name: cilium
    repo_url: https://helm.cilium.io/

- name: Install Cilium
  kubernetes.core.helm:
    name: cilium
    chart_ref: cilium/cilium
    release_namespace: kube-system
    values:
      version: "{{ cilium_version }}"
      kubeProxyReplacement: true
      k8sServiceHost: "{{ hostvars['localhost']['k3s_server_ip'] }}"
      k8sServicePort: 6443
      gatewayAPI:
        enabled: true
      replicas: 1
      ipam:
        operator:
          clusterPoolIPv4PodCIDRList: 10.42.0.0/16
      # optionally enable L2 announcements for LoadBalancer IPs
      l2announcements:
        enabled: true

- name: Create L2 announcement policy for Cilium
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'l2-policy.yaml.j2') }}"

# Apply the templated Secret in homelab/ansible/roles/argocd_bootstrap/templates/homelab-secret.yaml.j2
- name: Apply GitHub App repo credentials to ArgoCD
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'homelab-secret.yaml.j2') }}"

- name: Create App-of-Apps homelab-root-application in ArgoCD
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'root-app.yaml.j2') }}"
    